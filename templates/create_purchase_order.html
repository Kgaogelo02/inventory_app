{% extends "base.html" %}

{% block title %}Create Purchase Order - Mabutsi(Inventory Management System){% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-file-invoice"></i> Create Purchase Order</h1>
    <a href="{{ url_for('purchase_orders') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Purchase Orders
    </a>
</div>

<div class="form-container">
    <form method="POST" class="product-form" id="poForm">
        <div class="form-row">
            <div class="form-group">
                <label for="supplier_id">
                    <i class="fas fa-truck"></i> Supplier *
                </label>
                <select id="supplier_id" name="supplier_id" required>
                    <option value="">-- Select Supplier --</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier[0] }}">{{ supplier[1] }}</option>
                    {% endfor %}
                </select>
                {% if not suppliers %}
                <small class="form-text text-danger">
                    No suppliers available. <a href="{{ url_for('add_supplier') }}">Add a supplier first</a>
                </small>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="product_id">
                    <i class="fas fa-box"></i> Product *
                </label>
                <select id="product_id" name="product_id" required onchange="showProductInfo()">
                    <option value="">-- Select Product --</option>
                    {% for product in products %}
                    <option value="{{ product[0] }}" 
                            data-stock="{{ product[2] }}" 
                            data-minstock="{{ product[3] }}">
                        {{ product[1] }} (Current Stock: {{ product[2] }})
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div id="productInfo" style="display: none;" class="product-info-card">
            <h3><i class="fas fa-info-circle"></i> Product Status</h3>
            <div class="info-grid">
                <div>
                    <strong>Current Stock:</strong>
                    <span id="infoStock">0</span> units
                </div>
                <div>
                    <strong>Minimum Stock:</strong>
                    <span id="infoMinStock">0</span> units
                </div>
                <div id="stockStatus">
                    <!-- Dynamic stock status -->
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="quantity">
                    <i class="fas fa-sort-numeric-up"></i> Quantity to Order *
                </label>
                <input type="number" id="quantity" name="quantity" min="1" required placeholder="0" oninput="calculateTotal()">
                <small class="form-text">Number of items to purchase</small>
            </div>

            <div class="form-group">
                <label for="cost_per_unit">
                    <i class="fas fa-dollar-sign"></i> Cost per Unit (R) *
                </label>
                <input type="number" id="cost_per_unit" name="cost_per_unit" step="0.01" min="0" required placeholder="0.00" oninput="calculateTotal()">
                <small class="form-text">Purchase price from supplier</small>
            </div>
        </div>

        <div class="form-group">
            <label for="expected_delivery">
                <i class="fas fa-calendar"></i> Expected Delivery Date
            </label>
            <input type="date" id="expected_delivery" name="expected_delivery">
        </div>

        <div class="form-group">
            <label for="notes">
                <i class="fas fa-sticky-note"></i> Notes
            </label>
            <textarea id="notes" name="notes" rows="3" placeholder="Additional information about this order..."></textarea>
        </div>

        <div id="orderSummary" style="display: none;" class="sale-preview">
            <h3><i class="fas fa-calculator"></i> Order Summary</h3>
            <div class="preview-grid">
                <div class="preview-item">
                    <span>Units Ordered:</span>
                    <strong><span id="summaryQuantity">0</span> units</strong>
                </div>
                <div class="preview-item">
                    <span>Cost per Unit:</span>
                    <strong>R <span id="summaryCost">0.00</span></strong>
                </div>
                <div class="preview-item total">
                    <span>Total Order Cost:</span>
                    <strong>R <span id="summaryTotal">0.00</span></strong>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success btn-lg" {% if not suppliers %}disabled{% endif %}>
                <i class="fas fa-check-circle"></i> Create Purchase Order
            </button>
            <a href="{{ url_for('purchase_orders') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<script>
function showProductInfo() {
    const select = document.getElementById('product_id');
    const selectedOption = select.options[select.selectedIndex];
    const productInfo = document.getElementById('productInfo');
    const stockStatus = document.getElementById('stockStatus');
    
    if (selectedOption.value) {
        const stock = parseInt(selectedOption.dataset.stock);
        const minStock = parseInt(selectedOption.dataset.minstock);
        
        document.getElementById('infoStock').textContent = stock;
        document.getElementById('infoMinStock').textContent = minStock;
        
        // Show stock status
        if (stock <= minStock) {
            stockStatus.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Stock is LOW - Order needed!</span>';
        } else {
            stockStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Stock is adequate</span>';
        }
        
        productInfo.style.display = 'block';
    } else {
        productInfo.style.display = 'none';
    }
}

function calculateTotal() {
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const cost = parseFloat(document.getElementById('cost_per_unit').value) || 0;
    const summary = document.getElementById('orderSummary');
    
    if (quantity > 0 && cost > 0) {
        const total = quantity * cost;
        
        document.getElementById('summaryQuantity').textContent = quantity;
        document.getElementById('summaryCost').textContent = cost.toFixed(2);
        document.getElementById('summaryTotal').textContent = total.toFixed(2);
        
        summary.style.display = 'block';
    } else {
        summary.style.display = 'none';
    }
}
</script>

{% endblock %}