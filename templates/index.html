{% extends "base.html" %}

{% block title %}Dashboard - Mabutsi(Inventory Management System){% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="fas fa-chart-pie"></i> Dashboard</h1>
    <div class="header-actions">
        <a href="{{ url_for('change_password') }}" class="btn btn-secondary">
            <i class="fas fa-key"></i> Change Password
        </a>
        <a href="{{ url_for('export') }}" class="btn btn-secondary">
            <i class="fas fa-download"></i> Export Inventory
        </a>
        <a href="{{ url_for('export_sales') }}" class="btn btn-secondary">
            <i class="fas fa-file-csv"></i> Export Sales
        </a>
    </div>
</div>

<!-- DASHBOARD SUMMARY CARDS -->
<div class="stats-grid">
    <div class="stat-card stat-primary">
        <div class="stat-icon">
            <i class="fas fa-box"></i>
        </div>
        <div class="stat-details">
            <h3>{{ total_products }}</h3>
            <p>Total Products</p>
        </div>
    </div>

    <div class="stat-card stat-success">
        <div class="stat-icon">
            <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="stat-details">
            <h3>{{ total_sales }}</h3>
            <p>Items Sold</p>
        </div>
    </div>

    <div class="stat-card stat-info">
        <div class="stat-icon">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-details">
            <h3>R {{ "%.2f"|format(total_revenue) }}</h3>
            <p>Total Revenue</p>
        </div>
    </div>

    <div class="stat-card stat-warning">
        <div class="stat-icon">
            <i class="fas fa-hand-holding-usd"></i>
        </div>
        <div class="stat-details">
            <h3>R {{ "%.2f"|format(total_profit) }}</h3>
            <p>Total Profit</p>
        </div>
    </div>
</div>

<!-- TODAY'S STATS -->
<div class="section-header">
    <h2><i class="fas fa-calendar-day"></i> Today's Performance</h2>
</div>
<div class="stats-grid stats-grid-2">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="stat-details">
            <h3>{{ daily_items }}</h3>
            <p>Items Sold Today</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-coins"></i>
        </div>
        <div class="stat-details">
            <h3>R {{ "%.2f"|format(daily_value) }}</h3>
            <p>Revenue Today</p>
        </div>
    </div>
</div>

<!-- LOW STOCK ALERTS -->
{% if low_stock_count > 0 %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Warning:</strong> {{ low_stock_count }} product(s) have low stock (â‰¤5 units)
</div>
{% endif %}

<!-- SEARCH AND FILTERS -->
<div class="section-header">
    <h2><i class="fas fa-boxes"></i> Product Inventory</h2>
</div>
<div class="toolbar">
    <form method="GET" class="search-form">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" name="search" placeholder="Search products..." value="{{ search_query }}">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>
</div>

<!-- PRODUCT TABLE -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Category</th>
                <th>Cost Price</th>
                <th>Selling Price</th>
                <th>Stock</th>
                <th>Profit Margin</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product[0] }}</td>
                <td>
                    <strong>{{ product[1] }}</strong>
                    {% if product[6] %}
                    <br><small class="text-muted"><i class="fas fa-barcode"></i> {{ product[6] }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if product[5] %}
                    <span class="badge badge-info">{{ product[5] }}</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>R {{ "%.2f"|format(product[2]) }}</td>
                <td>R {{ "%.2f"|format(product[3]) }}</td>
                <td>
                    {% if product[4] <= product[5] %}
                        <span class="badge badge-danger">{{ product[4] }} (LOW)</span>
                    {% elif product[4] <= product[5] * 2 %}
                        <span class="badge badge-warning">{{ product[4] }}</span>
                    {% else %}
                        <span class="badge badge-success">{{ product[4] }}</span>
                    {% endif %}
                </td>
                <td>
                    {% set margin = ((product[3] - product[2]) / product[2] * 100) if product[2] > 0 else 0 %}
                    <span class="{% if margin >= 30 %}text-success{% elif margin >= 15 %}text-warning{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(margin) }}%
                    </span>
                </td>
                <td class="actions">
                    <a href="{{ url_for('edit_product', product_id=product[0]) }}" class="btn btn-sm btn-primary" title="Edit">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('delete_product', product_id=product[0]) }}" 
                       class="btn btn-sm btn-danger" 
                       onclick="return confirm('Are you sure you want to delete this product?')"
                       title="Delete">
                        <i class="fas fa-trash"></i>
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center">
                    {% if search_query %}
                        No products found matching "{{ search_query }}"
                    {% else %}
                        No products available. <a href="{{ url_for('add_product') }}">Add your first product</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- TOP SELLING PRODUCTS -->
{% if product_history %}
<div class="section-header">
    <h2><i class="fas fa-trophy"></i> Top Selling Products</h2>
</div>
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Product</th>
                <th>Units Sold</th>
                <th>Revenue</th>
            </tr>
        </thead>
        <tbody>
            {% for item in product_history %}
            <tr>
                <td>
                    {% if loop.index == 1 %}
                        <i class="fas fa-trophy text-warning"></i>
                    {% elif loop.index == 2 %}
                        <i class="fas fa-medal text-muted"></i>
                    {% elif loop.index == 3 %}
                        <i class="fas fa-award" style="color: #cd7f32;"></i>
                    {% else %}
                        {{ loop.index }}
                    {% endif %}
                </td>
                <td><strong>{{ item[0] }}</strong></td>
                <td>{{ item[1] }} units</td>
                <td>R {{ "%.2f"|format(item[2]) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endblock %}

