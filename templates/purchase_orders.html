{% extends "base.html" %}

{% block title %}Purchase Orders - Mabutsi(IMS){% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-file-invoice"></i> Purchase Orders</h1>
    <div class="header-actions">
        <a href="{{ url_for('create_purchase_order') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create Purchase Order
        </a>
    </div>
</div>

<!-- Statistics -->
<div class="stats-grid">
    {% set pending_count = orders|selectattr('7', 'equalto', 'pending')|list|length %}
    {% set received_count = orders|selectattr('7', 'equalto', 'received')|list|length %}
    {% set total_value = orders|sum(attribute=5)|default(0) %}
    
    <div class="stat-card stat-warning">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-details">
            <h3>{{ pending_count }}</h3>
            <p>Pending Orders</p>
        </div>
    </div>

    <div class="stat-card stat-success">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-details">
            <h3>{{ received_count }}</h3>
            <p>Received Orders</p>
        </div>
    </div>

    <div class="stat-card stat-info">
        <div class="stat-icon">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-details">
            <h3>R {{ "%.2f"|format(total_value) }}</h3>
            <p>Total Value</p>
        </div>
    </div>
</div>

<div class="section-header">
    <h2><i class="fas fa-list"></i> Order History</h2>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>PO #</th>
                <th>Supplier</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Cost/Unit</th>
                <th>Total Cost</th>
                <th>Status</th>
                <th>Order Date</th>
                <th>Expected Delivery</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td><strong>#{{ order[0] }}</strong></td>
                <td>{{ order[11] }}</td>
                <td>{{ order[12] }}</td>
                <td>{{ order[3] }} units</td>
                <td>R {{ "%.2f"|format(order[4]) }}</td>
                <td><strong>R {{ "%.2f"|format(order[5]) }}</strong></td>
                <td>
                    {% if order[6] == 'pending' %}
                    <span class="badge badge-warning">Pending</span>
                    {% elif order[6] == 'received' %}
                    <span class="badge badge-success">Received</span>
                    {% elif order[6] == 'cancelled' %}
                    <span class="badge badge-danger">Cancelled</span>
                    {% endif %}
                </td>
                <td>{{ order[7]|format_date }}</td>
                <td>
                    {% if order[8] %}
                    {{ order[8] }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="actions">
                    {% if order[6] == 'pending' %}
                    <a href="{{ url_for('receive_purchase_order', order_id=order[0]) }}" 
                       class="btn btn-sm btn-success" 
                       onclick="return confirm('Mark this order as received? Stock will be updated.')"
                       title="Receive Order">
                        <i class="fas fa-check"></i> Receive
                    </a>
                    <a href="{{ url_for('cancel_purchase_order', order_id=order[0]) }}" 
                       class="btn btn-sm btn-danger" 
                       onclick="return confirm('Cancel this order?')"
                       title="Cancel">
                        <i class="fas fa-times"></i>
                    </a>
                    {% elif order[6] == 'received' %}
                    <span class="text-success">
                        <i class="fas fa-check-circle"></i> Completed
                    </span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="10" class="text-center">
                    No purchase orders yet. <a href="{{ url_for('create_purchase_order') }}">Create your first order</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}